name: AICODE Preprocess

on:
  repository_dispatch:
    types: [aicode]

jobs:
  preprocess:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install agent dependencies
        working-directory: .github/agent
        run: npm install

      - name: Preprocess task to user story
        id: preprocess
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PREPROCESSING_MODEL: ${{ secrets.PREPROCESSING_MODEL || 'gpt-4o-mini' }}
          TASK: ${{ github.event.client_payload.task }}
          REQUESTER: ${{ github.event.client_payload.requester }}
          CONFLUENCE_URL: ${{ secrets.CONFLUENCE_URL }}
          CONFLUENCE_EMAIL: ${{ secrets.CONFLUENCE_EMAIL }}
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
          CONFLUENCE_SPACE_KEY: ${{ secrets.CONFLUENCE_SPACE_KEY || 'AICODE' }}
          CONFLUENCE_PARENT_PAGE_ID: ${{ secrets.CONFLUENCE_PARENT_PAGE_ID || '5177529' }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          OUTPUT=$(node .github/agent/preprocess-task.mjs 2>&1)
          echo "$OUTPUT"

          # Extract enhanced task from output
          if echo "$OUTPUT" | grep -q "ENHANCED_TASK_START"; then
            ENHANCED_TASK=$(echo "$OUTPUT" | sed -n '/ENHANCED_TASK_START/,/ENHANCED_TASK_END/p' | sed '1d;$d' | sed ':a;N;$!ba;s/\n/ /g')
            echo "enhanced_task<<EOF" >> $GITHUB_OUTPUT
            echo "$ENHANCED_TASK" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            # Fallback to original task
            echo "enhanced_task=${{ github.event.client_payload.task }}" >> $GITHUB_OUTPUT
          fi

          # Extract JSON if available
          JSON_LINE=$(echo "$OUTPUT" | grep "ENHANCED_TASK_JSON:" || true)
          if [ -n "$JSON_LINE" ]; then
            JSON_DATA=$(echo "$JSON_LINE" | sed 's/ENHANCED_TASK_JSON://')
            # Write JSON to file to avoid shell quoting issues when reading back
            echo "$JSON_DATA" > /tmp/task_json.json
            
            # Extract Confluence URL
            CONFLUENCE_URL=$(echo "$JSON_DATA" | jq -r '.confluenceUrl // "N/A"')
            echo "confluence_url=$CONFLUENCE_URL" >> $GITHUB_OUTPUT
            echo "has_json=true" >> $GITHUB_OUTPUT
          else
            echo "confluence_url=N/A" >> $GITHUB_OUTPUT
            echo "has_json=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger main agent workflow
        if: always()
        run: |
          # Read enhanced task from JSON file to avoid shell quoting issues
          # Check if JSON file exists from previous step
          if [ -f /tmp/task_json.json ]; then
            # Read JSON from file and extract values
            if jq -e . /tmp/task_json.json >/dev/null 2>&1; then
              # Valid JSON, extract values
              ENHANCED_TASK=$(jq -r '.enhanced // empty' /tmp/task_json.json)
              ORIGINAL_TASK=$(jq -r '.original // empty' /tmp/task_json.json)
              CONFLUENCE_URL=$(jq -r '.confluenceUrl // "N/A"' /tmp/task_json.json)
            else
              # Invalid JSON, fallback to outputs
              ENHANCED_TASK="${{ steps.preprocess.outputs.enhanced_task }}"
              ORIGINAL_TASK="${{ github.event.client_payload.task }}"
              CONFLUENCE_URL="${{ steps.preprocess.outputs.confluence_url }}"
            fi
          else
            # No JSON file, fallback to outputs
            ENHANCED_TASK="${{ steps.preprocess.outputs.enhanced_task }}"
            ORIGINAL_TASK="${{ github.event.client_payload.task }}"
            CONFLUENCE_URL="${{ steps.preprocess.outputs.confluence_url }}"
          fi
          
          # Use GitHub Actions context for other values (these are safe)
          REQUESTER="${{ github.event.client_payload.requester }}"
          CHANNEL="${{ github.event.client_payload.channel }}"
          TIMESTAMP="${{ github.event.client_payload.timestamp }}"
          RUN_ID="${{ github.run_id }}"

          # Use jq to properly construct JSON payload with proper escaping
          PAYLOAD=$(jq -n \
            --arg event_type "aicode-enhanced" \
            --arg task "$ENHANCED_TASK" \
            --arg original_task "$ORIGINAL_TASK" \
            --arg requester "$REQUESTER" \
            --arg channel "$CHANNEL" \
            --arg timestamp "$TIMESTAMP" \
            --arg preprocessing_run_id "$RUN_ID" \
            --arg confluence_url "$CONFLUENCE_URL" \
            '{
              event_type: $event_type,
              client_payload: {
                task: $task,
                original_task: $original_task,
                requester: $requester,
                channel: $channel,
                timestamp: $timestamp,
                preprocessing_run_id: $preprocessing_run_id,
                confluence_url: $confluence_url
              }
            }')

          curl -X POST "https://api.github.com/repos/${{ github.repository }}/dispatches" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"

      - name: Notify Slack on preprocessing completion
        if: always()
        run: |
          if [ "${{ steps.preprocess.outcome }}" == "success" ]; then
            # Read from JSON file to avoid shell quoting issues
            if [ -f /tmp/task_json.json ] && jq -e . /tmp/task_json.json >/dev/null 2>&1; then
              # Read from JSON file (safest method)
              ORIGINAL_TASK=$(jq -r '.original // empty' /tmp/task_json.json)
              ENHANCED_TASK=$(jq -r '.enhanced // empty' /tmp/task_json.json)
            else
              # Fallback: read original from event, enhanced from file if available
              ORIGINAL_TASK="${{ github.event.client_payload.task }}"
              # Try to read enhanced_task from file, or use a safe default
              if [ -f /tmp/task_json.json ]; then
                ENHANCED_TASK=$(jq -r '.enhanced // empty' /tmp/task_json.json || echo "$ORIGINAL_TASK")
              else
                # Last resort: use original task as enhanced (better than breaking)
                ENHANCED_TASK="$ORIGINAL_TASK"
              fi
            fi
            
            # Use jq to properly construct JSON payload with proper escaping
            PAYLOAD=$(jq -n \
              --arg text "üìù Task preprocessed and enhanced. Triggering code generation..." \
              --arg original "$ORIGINAL_TASK" \
              --arg enhanced "$ENHANCED_TASK" \
              '{
                text: $text,
                blocks: [{
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: ("üìù *Task Preprocessing Complete*\n\n*Original:* " + $original + "\n\n*Enhanced:* " + $enhanced)
                  }
                }]
              }')
            
            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD"
          else
            PAYLOAD=$(jq -n '{
              text: "‚ö†Ô∏è Preprocessing failed, using original task",
              blocks: [{
                type: "section",
                text: {
                  type: "mrkdwn",
                  text: "‚ö†Ô∏è *Preprocessing Warning*\n\nPreprocessing failed, but code generation will continue with original task."
                }
              }]
            }')
            
            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD"
          fi
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
