name: AICODE Preprocess

on:
  repository_dispatch:
    types: [aicode]

jobs:
  preprocess:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install agent dependencies
        working-directory: .github/agent
        run: npm install

      - name: Preprocess task to user story
        id: preprocess
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PREPROCESSING_MODEL: ${{ secrets.PREPROCESSING_MODEL || 'gpt-4o-mini' }}
          TASK: ${{ github.event.client_payload.task }}
          REQUESTER: ${{ github.event.client_payload.requester }}
          CONFLUENCE_URL: ${{ secrets.CONFLUENCE_URL }}
          CONFLUENCE_EMAIL: ${{ secrets.CONFLUENCE_EMAIL }}
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
          CONFLUENCE_SPACE_KEY: ${{ secrets.CONFLUENCE_SPACE_KEY || 'AICODE' }}
          CONFLUENCE_PARENT_PAGE_ID: ${{ secrets.CONFLUENCE_PARENT_PAGE_ID || '5177529' }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          OUTPUT=$(node .github/agent/preprocess-task.mjs 2>&1)
          echo "$OUTPUT"

          # Extract enhanced task from output
          if echo "$OUTPUT" | grep -q "ENHANCED_TASK_START"; then
            ENHANCED_TASK=$(echo "$OUTPUT" | sed -n '/ENHANCED_TASK_START/,/ENHANCED_TASK_END/p' | sed '1d;$d' | sed ':a;N;$!ba;s/\n/ /g')
            echo "enhanced_task<<EOF" >> $GITHUB_OUTPUT
            echo "$ENHANCED_TASK" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            # Fallback to original task
            echo "enhanced_task=${{ github.event.client_payload.task }}" >> $GITHUB_OUTPUT
          fi

          # Extract JSON if available
          JSON_LINE=$(echo "$OUTPUT" | grep "ENHANCED_TASK_JSON:" || true)
          if [ -n "$JSON_LINE" ]; then
            JSON_DATA=$(echo "$JSON_LINE" | sed 's/ENHANCED_TASK_JSON://')
            echo "task_json=$JSON_DATA" >> $GITHUB_OUTPUT

            # Extract Confluence URL
            CONFLUENCE_URL=$(echo "$JSON_DATA" | jq -r '.confluenceUrl // "N/A"')
            echo "confluence_url=$CONFLUENCE_URL" >> $GITHUB_OUTPUT
          else
            echo "confluence_url=N/A" >> $GITHUB_OUTPUT
          fi

      - name: Trigger main agent workflow
        if: always()
        run: |
          # Read enhanced task from JSON output to avoid shell quoting issues
          TASK_JSON="${{ steps.preprocess.outputs.task_json }}"
          
          if [ -n "$TASK_JSON" ] && [ "$TASK_JSON" != "null" ]; then
            # Extract values from JSON using jq (handles all escaping automatically)
            ENHANCED_TASK=$(echo "$TASK_JSON" | jq -r '.enhanced // empty')
            ORIGINAL_TASK=$(echo "$TASK_JSON" | jq -r '.original // empty')
            CONFLUENCE_URL=$(echo "$TASK_JSON" | jq -r '.confluenceUrl // "N/A"')
          else
            # Fallback to outputs if JSON not available
          ENHANCED_TASK="${{ steps.preprocess.outputs.enhanced_task }}"
          ORIGINAL_TASK="${{ github.event.client_payload.task }}"
            CONFLUENCE_URL="${{ steps.preprocess.outputs.confluence_url }}"
          fi
          
          # Use GitHub Actions context for other values (these are safe)
          REQUESTER="${{ github.event.client_payload.requester }}"
          CHANNEL="${{ github.event.client_payload.channel }}"
          TIMESTAMP="${{ github.event.client_payload.timestamp }}"
          RUN_ID="${{ github.run_id }}"

          # Use jq to properly construct JSON payload with proper escaping
          PAYLOAD=$(jq -n \
            --arg event_type "aicode-enhanced" \
            --arg task "$ENHANCED_TASK" \
            --arg original_task "$ORIGINAL_TASK" \
            --arg requester "$REQUESTER" \
            --arg channel "$CHANNEL" \
            --arg timestamp "$TIMESTAMP" \
            --arg preprocessing_run_id "$RUN_ID" \
            --arg confluence_url "$CONFLUENCE_URL" \
            '{
              event_type: $event_type,
              client_payload: {
                task: $task,
                original_task: $original_task,
                requester: $requester,
                channel: $channel,
                timestamp: $timestamp,
                preprocessing_run_id: $preprocessing_run_id,
                confluence_url: $confluence_url
              }
            }')

          curl -X POST "https://api.github.com/repos/${{ github.repository }}/dispatches" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"

      - name: Notify Slack on preprocessing completion
        if: always()
        run: |
          if [ "${{ steps.preprocess.outcome }}" == "success" ]; then
            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d "{\"text\":\"üìù Task preprocessed and enhanced. Triggering code generation...\",\"blocks\":[{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"üìù *Task Preprocessing Complete*\\n\\n*Original:* ${{ github.event.client_payload.task }}\\n\\n*Enhanced:* ${{ steps.preprocess.outputs.enhanced_task }}\"}}]}"
          else
            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d "{\"text\":\"‚ö†Ô∏è Preprocessing failed, using original task\",\"blocks\":[{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"‚ö†Ô∏è *Preprocessing Warning*\\n\\nPreprocessing failed, but code generation will continue with original task.\"}}]}"
          fi
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
