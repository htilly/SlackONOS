name: Enhance Feature Requests

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: string

# Prevent parallel runs for the same issue
# When both 'opened' and 'labeled' events fire, cancel the older run
concurrency:
  group: enhance-feature-request-${{ github.event.issue.number || inputs.issue_number }}
  cancel-in-progress: true

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  check-label:
    runs-on: ubuntu-latest
    outputs:
      has_enhancement: ${{ steps.check.outputs.has_enhancement }}
      already_enhanced: ${{ steps.check.outputs.already_enhanced }}
      issue_number: ${{ steps.set_issue.outputs.issue_number }}
      should_skip: ${{ steps.skip-opened.outputs.skip }}
    steps:
      - name: Set issue number
        id: set_issue
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "issue_number=${{ inputs.issue_number }}" >> "$GITHUB_OUTPUT"
          else
            echo "issue_number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Check if opened event should be skipped
        id: skip-opened
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Default to not skipping (for labeled events and workflow_dispatch)
          SKIP_VALUE="false"
          
          # If issue is opened with enhancement label already present,
          # skip this run (labeled event will handle it to avoid duplicate runs)
          if [ "${{ github.event_name }}" = "issues" ] && [ "${{ github.event.action }}" = "opened" ]; then
            ISSUE_JSON=$(curl -s \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER")
            LABELS=$(echo "$ISSUE_JSON" | jq -r '.labels[].name' | tr '\n' ' ')
            if echo "$LABELS" | grep -qw "enhancement"; then
              echo "‚ö†Ô∏è  Issue opened with enhancement label already present - skipping (labeled event will handle it)"
              SKIP_VALUE="true"
            fi
          fi
          echo "skip=$SKIP_VALUE" >> "$GITHUB_OUTPUT"

      - name: Fetch and check issue
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.set_issue.outputs.issue_number }}
        run: |
          set -e

          # Fetch issue data
          ISSUE_JSON=$(curl -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER")

          # Write to temp file for safe parsing
          echo "$ISSUE_JSON" > /tmp/issue.json

          # Extract labels
          LABELS=$(jq -r '.labels[].name' /tmp/issue.json)

          # Check for enhancement label (word boundary, not exact line)
          if echo "$LABELS" | grep -qw "enhancement"; then
            echo "‚úÖ Issue has enhancement label"
            echo "has_enhancement=true" >> "$GITHUB_OUTPUT"
          else
            echo "‚ùå No enhancement label found"
            echo "has_enhancement=false" >> "$GITHUB_OUTPUT"
          fi

          # Check if already enhanced
          BODY=$(jq -r '.body // ""' /tmp/issue.json)
          if echo "$BODY" | grep -qF "## üìù Enhanced Feature Request"; then
            echo "‚ö†Ô∏è  Issue already enhanced - skipping"
            echo "already_enhanced=true" >> "$GITHUB_OUTPUT"
          else
            echo "‚úÖ Issue not yet enhanced"
            echo "already_enhanced=false" >> "$GITHUB_OUTPUT"
          fi

  preprocess:
    runs-on: ubuntu-latest
    needs: check-label
    if: needs.check-label.outputs.should_skip != 'true' && needs.check-label.outputs.has_enhancement == 'true' && needs.check-label.outputs.already_enhanced == 'false'
    outputs:
      enhanced_task: ${{ steps.preprocess.outputs.enhanced_task }}
      issue_title: ${{ steps.fetch.outputs.issue_title }}
      issue_user: ${{ steps.fetch.outputs.issue_user }}
      issue_body: ${{ steps.fetch.outputs.issue_body }}
      issue_created: ${{ steps.fetch.outputs.issue_created }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop

      - uses: actions/setup-node@v4
        with:
          node-version: '20.20.0'
          cache: npm

      - name: Install dependencies
        working-directory: .github/agent
        run: npm install

      - name: Fetch full issue data
        id: fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.check-label.outputs.issue_number }}
        run: |
          ISSUE_JSON=$(curl -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER")

          TITLE=$(echo "$ISSUE_JSON" | jq -r '.title')
          USER=$(echo "$ISSUE_JSON" | jq -r '.user.login')
          BODY=$(echo "$ISSUE_JSON" | jq -r '.body // ""')
          CREATED=$(echo "$ISSUE_JSON" | jq -r '.created_at')

          echo "issue_title=$TITLE" >> "$GITHUB_OUTPUT"
          echo "issue_user=$USER" >> "$GITHUB_OUTPUT"
          echo "issue_created=$CREATED" >> "$GITHUB_OUTPUT"
          {
            echo "issue_body<<EOF"
            echo "$BODY"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Preprocess issue
        id: preprocess
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PREPROCESSING_MODEL: ${{ secrets.PREPROCESSING_MODEL }}
          TASK: ${{ steps.fetch.outputs.issue_title }}
          REQUESTER: ${{ steps.fetch.outputs.issue_user }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          set -e
          OUTPUT=$(node .github/agent/preprocess-task.mjs 2>&1)
          echo "$OUTPUT"

          if echo "$OUTPUT" | grep -q "ENHANCED_TASK_START"; then
            ENHANCED=$(echo "$OUTPUT" | sed -n '/ENHANCED_TASK_START/,/ENHANCED_TASK_END/p' | sed '1d;$d')
          else
            ENHANCED="$TASK"
          fi

          {
            echo "enhanced_task<<EOF"
            echo "$ENHANCED"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  create-confluence:
    runs-on: ubuntu-latest
    needs: [check-label, preprocess]
    outputs:
      confluence_url: ${{ steps.confluence.outputs.confluence_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop

      - uses: actions/setup-node@v4
        with:
          node-version: '20.20.0'
          cache: npm

      - name: Install dependencies
        working-directory: .github/agent
        run: npm install

      - name: Create Confluence page
        id: confluence
        env:
          TASK: ${{ needs.preprocess.outputs.issue_title }}
          REQUESTER: ${{ needs.preprocess.outputs.issue_user }}
          ISSUE_NUMBER: ${{ needs.check-label.outputs.issue_number }}
          CONFLUENCE_URL: ${{ secrets.CONFLUENCE_URL }}
          CONFLUENCE_EMAIL: ${{ secrets.CONFLUENCE_EMAIL }}
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
          CONFLUENCE_SPACE_KEY: ${{ secrets.CONFLUENCE_SPACE_KEY }}
          CONFLUENCE_PARENT_PAGE_ID: ${{ secrets.CONFLUENCE_PARENT_PAGE_ID }}
          ENHANCED_TASK: ${{ needs.preprocess.outputs.enhanced_task }}
        run: |
          set -e
          OUTPUT=$(node .github/agent/create-confluence.mjs 2>&1)
          echo "$OUTPUT"

          URL=$(echo "$OUTPUT" | grep "CONFLUENCE_URL:" | sed 's/CONFLUENCE_URL://' | tr -d '[:space:]')
          echo "confluence_url=$URL" >> "$GITHUB_OUTPUT"

  update-issue:
    runs-on: ubuntu-latest
    needs: [check-label, preprocess, create-confluence]
    steps:
      - name: Update issue body
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.check-label.outputs.issue_number }}
        run: |
          set -euo pipefail

          # Use jq to safely build JSON with proper escaping
          jq -n \
            --arg enhanced "${{ needs.preprocess.outputs.enhanced_task }}" \
            --arg confluence "${{ needs.create-confluence.outputs.confluence_url }}" \
            --arg original "${{ needs.preprocess.outputs.issue_body }}" \
            --arg requester "${{ needs.preprocess.outputs.issue_user }}" \
            --arg created "${{ needs.preprocess.outputs.issue_created }}" \
            '{
              body: (
                "## üìù Enhanced Feature Request\n\n" +
                $enhanced +
                "\n\n---\n\n" +
                "üìÑ **Requirements documented:** " +
                (if $confluence != "" then $confluence else "_Not available_" end) +
                "\n\n---\n\n" +
                "## üìã Original Request\n\n" +
                $original +
                "\n\n---\n\n" +
                "**Requested by:** " + $requester + "\n" +
                "**Created:** " + $created
              )
            }' \
          | curl -X PATCH \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              -d @- \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER"

          echo "‚úÖ Issue updated with enhanced + original content"



  add-comment:
    runs-on: ubuntu-latest
    needs: [check-label, update-issue]
    steps:
      - name: Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.check-label.outputs.issue_number }}
        run: |
          COMMENT="ü§ñ **Feature request enhanced!**

          Issue description and requirements are now structured and documented."

          jq -n --arg body "$COMMENT" '{body:$body}' \
          | curl -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              -d @- \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments"

  generate-implementation:
    runs-on: ubuntu-latest
    needs: [check-label, preprocess]
    # Run if issue has enhancement label and isn't already enhanced
    # Run even if preprocess was skipped/failed (will use fallback)
    if: |
      needs.check-label.outputs.has_enhancement == 'true' &&
      needs.check-label.outputs.already_enhanced == 'false'
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.20.0'
          cache: npm

      - name: Install agent dependencies
        working-directory: .github/agent
        run: npm install

      - name: Prepare task data for Claude
        id: prepare-task
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.check-label.outputs.issue_number }}
          PREPROCESS_OUTCOME: ${{ needs.preprocess.outcome }}
          PREPROCESS_ENHANCED_TASK: ${{ needs.preprocess.outputs.enhanced_task }}
          PREPROCESS_ISSUE_TITLE: ${{ needs.preprocess.outputs.issue_title }}
        run: |
          # If preprocess succeeded, use its enriched output
          if [ "$PREPROCESS_OUTCOME" = "success" ] && [ -n "$PREPROCESS_ENHANCED_TASK" ]; then
            echo "‚úÖ Using enriched task from preprocess"
            {
              echo "enhanced_task<<EOF"
              echo "$PREPROCESS_ENHANCED_TASK"
              echo "EOF"
              echo "issue_title<<EOF"
              echo "$PREPROCESS_ISSUE_TITLE"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          else
            # Preprocess skipped/failed, fetch issue data as fallback
            echo "‚ö†Ô∏è  Preprocess $PREPROCESS_OUTCOME, fetching issue data as fallback"
            ISSUE_JSON=$(curl -s \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER")
            TITLE=$(echo "$ISSUE_JSON" | jq -r '.title')
            BODY=$(echo "$ISSUE_JSON" | jq -r '.body // ""')
            {
              echo "enhanced_task<<EOF"
              echo "$TITLE"
              echo "EOF"
              echo "issue_title<<EOF"
              echo "$TITLE"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Generate and apply implementation with Claude
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_MODEL: ${{ secrets.CLAUDE_MODEL }}
          ENHANCED_TASK: ${{ steps.prepare-task.outputs.enhanced_task }}
          TASK: ${{ steps.prepare-task.outputs.issue_title }}
          ISSUE_NUMBER: ${{ needs.check-label.outputs.issue_number }}
        run: |
          set -e
          OUTPUT=$(node .github/agent/generate-implementation.mjs 2>&1)
          echo "$OUTPUT"

          # Check if code was applied or if we have a fallback file
          if echo "$OUTPUT" | grep -q "IMPLEMENTATION_FILE:APPLIED"; then
            echo "code_applied=true" >> $GITHUB_OUTPUT
            CHANGED_FILES=$(echo "$OUTPUT" | grep "IMPLEMENTATION_CHANGED_FILES:" | sed 's/IMPLEMENTATION_CHANGED_FILES://' | tr -d '[:space:]')
            echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          else
            echo "code_applied=false" >> $GITHUB_OUTPUT
            IMPL_FILE=$(echo "$OUTPUT" | grep "IMPLEMENTATION_FILE:" | sed 's/IMPLEMENTATION_FILE://' | tr -d '[:space:]')
            echo "implementation_file=$IMPL_FILE" >> $GITHUB_OUTPUT
          fi

      - name: Create implementation branch and PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.check-label.outputs.issue_number }}
          CODE_APPLIED: ${{ steps.generate.outputs.code_applied }}
          CHANGED_FILES: ${{ steps.generate.outputs.changed_files }}
          IMPL_FILE: ${{ steps.generate.outputs.implementation_file }}
        run: |
          set -e

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create feature branch
          BRANCH_NAME="feature/issue-$ISSUE_NUMBER-implementation"
          git checkout -b "$BRANCH_NAME"

          # Check if code was applied or if we need to add fallback file
          if [ "$CODE_APPLIED" = "true" ]; then
            # Code was applied - add all changed files
            echo "‚úÖ Code changes were applied, staging all changes..."
            git add -A
            
            # Get list of changed files for commit message
            CHANGED=$(git diff --cached --name-only | tr '\n' ',' | sed 's/,$//')
            echo "Changed files: $CHANGED"
            
            # Create commit message
            COMMIT_MSG=$(cat <<EOF
          Implement feature request for issue #$ISSUE_NUMBER

          This is an AI-generated implementation created by Claude.
          Please review and test the changes.

          Changed files: $CHANGED
          Related issue: #$ISSUE_NUMBER
          EOF
            )
          elif [ -f "$IMPL_FILE" ]; then
            # Fallback: add the implementation plan file
            echo "‚ö†Ô∏è  Code application failed, adding implementation plan file..."
            git add "$IMPL_FILE"
            CHANGED="$IMPL_FILE"
            
            # Create commit message
            COMMIT_MSG=$(cat <<EOF
          Add implementation plan for issue #$ISSUE_NUMBER

          This is an AI-generated implementation plan created by Claude.
          Code application failed - please review the plan and implement manually.

          Related issue: #$ISSUE_NUMBER
          EOF
            )
          else
            echo "‚ùå No code changes and no implementation file found"
            exit 1
          fi
          
          git commit -m "$COMMIT_MSG"

          # Push branch
          git push -u origin "$BRANCH_NAME"

          # Create PR body
          if [ "$CODE_APPLIED" = "true" ]; then
            PR_BODY=$(cat <<EOF
          ## ü§ñ AI-Generated Implementation

          This PR contains an **actual code implementation** generated by Claude AI for issue #$ISSUE_NUMBER.

          ### ‚úÖ Changes Applied
          The following files were modified:
          $(echo "$CHANGED_FILES" | tr ',' '\n' | sed 's/^/          - /')

          ### üìù Review Notes
          Please review the changes and run tests before merging.
          EOF
            )
          else
            PR_BODY=$(cat <<EOF
          ## ü§ñ AI-Generated Implementation Plan

          This PR contains an implementation plan generated by Claude AI for issue #$ISSUE_NUMBER.

          ‚ö†Ô∏è **Note**: Code application failed. This PR contains a plan that needs manual implementation.

          ### üìã Implementation Plan
          See [implementation-$ISSUE_NUMBER.md](./implementation-$ISSUE_NUMBER.md) for details.

          ### ‚ö†Ô∏è Important
          This is an **AI-generated implementation plan**. Please:
          - Review the plan carefully
          - Implement the code changes manually
          - Test thoroughly before merging

          Closes #$ISSUE_NUMBER
          EOF
          )

            # Substitute environment variables in PR body
            PR_BODY=$(echo "$PR_BODY" | sed "s/\$ISSUE_NUMBER/$ISSUE_NUMBER/g")

            # Create PR
            PR_URL=$(gh pr create \
              --title "feat: Implementation plan for issue #$ISSUE_NUMBER" \
              --body "$PR_BODY" \
              --base develop \
              --head "$BRANCH_NAME" \
              --label "enhancement")

            # Extract PR number from URL (format: https://github.com/owner/repo/pull/123)
            PR_NUMBER=$(echo "$PR_URL" | sed -n 's/.*\/pull\/\([0-9]*\).*/\1/p')

            # Try to add ai-generated label if it exists (ignore error if label doesn't exist)
            if [ -n "$PR_NUMBER" ]; then
              gh pr edit "$PR_NUMBER" --add-label "ai-generated" 2>/dev/null || echo "‚ö†Ô∏è  Label 'ai-generated' not found, skipping"
            fi

            echo "‚úÖ Created PR for branch $BRANCH_NAME"
          else
            echo "‚ùå Implementation file not found: $IMPL_FILE"
            exit 1
          fi

      - name: Comment on issue with PR link
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.check-label.outputs.issue_number }}
        run: |
          COMMENT="üöÄ **Implementation PR Created!**

          An AI-generated implementation plan has been created. Check the pull request for details.

          Note: This is a starting point - please review and adapt the implementation as needed."

          jq -n --arg body "$COMMENT" '{body:$body}' \
          | curl -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              -d @- \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments"
