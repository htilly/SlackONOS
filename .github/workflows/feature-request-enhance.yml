name: Enhance Feature Requests

on:
  issues:
    types: [opened, labeled]

jobs:
  check-label:
    runs-on: ubuntu-latest
    outputs:
      has_enhancement: ${{ steps.check.outputs.has_enhancement }}
      already_enhanced: ${{ steps.check_enhanced.outputs.already_enhanced }}
    steps:
      - name: Check enhancement label
        id: check
        run: |
          set -e

          if [ "${{ github.event.action }}" = "labeled" ]; then
            if [ "${{ github.event.label.name }}" = "enhancement" ]; then
              echo "has_enhancement=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_enhancement=false" >> "$GITHUB_OUTPUT"
            fi
          else
            LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
            if [ -n "$LABELS" ] && echo "$LABELS" | grep -q "enhancement"; then
              echo "has_enhancement=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_enhancement=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Check if issue already enhanced
        id: check_enhanced
        run: |
          set -e
          BODY="${{ github.event.issue.body }}"
          if echo "$BODY" | grep -q "## .*Enhanced Feature Request"; then
            echo "already_enhanced=true" >> "$GITHUB_OUTPUT"
          else
            echo "already_enhanced=false" >> "$GITHUB_OUTPUT"
          fi

  preprocess:
    runs-on: ubuntu-latest
    needs: check-label
    if: needs.check-label.outputs.has_enhancement == 'true' && needs.check-label.outputs.already_enhanced == 'false'
    outputs:
      enhanced_task: ${{ steps.preprocess.outputs.enhanced_task }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        working-directory: .github/agent
        run: npm install

      - name: Preprocess issue
        id: preprocess
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PREPROCESSING_MODEL: ${{ secrets.PREPROCESSING_MODEL }}
          TASK: ${{ github.event.issue.title }}
          REQUESTER: ${{ github.event.issue.user.login }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          set -e
          OUTPUT=$(node .github/agent/preprocess-task.mjs 2>&1)
          echo "$OUTPUT"

          if echo "$OUTPUT" | grep -q "ENHANCED_TASK_START"; then
            ENHANCED=$(echo "$OUTPUT" | sed -n '/ENHANCED_TASK_START/,/ENHANCED_TASK_END/p' | sed '1d;$d')
          else
            ENHANCED="${{ github.event.issue.title }}"
          fi

          {
            echo "enhanced_task<<EOF"
            echo "$ENHANCED"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  create-confluence:
    runs-on: ubuntu-latest
    needs: preprocess
    permissions:
      issues: write
    outputs:
      confluence_url: ${{ steps.confluence.outputs.confluence_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        working-directory: .github/agent
        run: npm install

      - name: Create Confluence page
        id: confluence
        env:
          TASK: ${{ github.event.issue.title }}
          REQUESTER: ${{ github.event.issue.user.login }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          CONFLUENCE_URL: ${{ secrets.CONFLUENCE_URL }}
          CONFLUENCE_EMAIL: ${{ secrets.CONFLUENCE_EMAIL }}
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
          CONFLUENCE_SPACE_KEY: ${{ secrets.CONFLUENCE_SPACE_KEY }}
          CONFLUENCE_PARENT_PAGE_ID: ${{ secrets.CONFLUENCE_PARENT_PAGE_ID }}
          ENHANCED_TASK: ${{ needs.preprocess.outputs.enhanced_task }}
        run: |
          set -e
          OUTPUT=$(node .github/agent/create-confluence.mjs 2>&1)
          echo "$OUTPUT"

          URL=$(echo "$OUTPUT" | grep "CONFLUENCE_URL:" | sed 's/CONFLUENCE_URL://')
          echo "confluence_url=$URL" >> "$GITHUB_OUTPUT"

  update-issue:
    runs-on: ubuntu-latest
    needs: [preprocess, create-confluence]
    permissions:
      issues: write
    steps:
      - name: Update issue body
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENHANCED: ${{ needs.preprocess.outputs.enhanced_task }}
          CONFLUENCE_URL: ${{ needs.create-confluence.outputs.confluence_url }}
        run: |
          set -euo pipefail

          if ! command -v jq >/dev/null; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

          ORIGINAL=$(curl -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}" \
            | jq -r '.body // ""')

          BODY=$(jq -n \
            --arg enhanced "$ENHANCED" \
            --arg original "$ORIGINAL" \
            --arg confluence "$CONFLUENCE_URL" \
            --arg requester "${{ github.event.issue.user.login }}" \
            --arg created "${{ github.event.issue.created_at }}" \
            '"## üìù Enhanced Feature Request\n\n"
             + $enhanced
             + "\n\n---\n\nüìÑ **Requirements documented:** "
             + $confluence
             + "\n\n---\n\n## üìã Original Request\n\n"
             + $original
             + "\n\n---\n\n**Requested by:** "
             + $requester
             + "\n**Created:** "
             + $created')

          curl -X PATCH \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg body "$BODY" '{body:$body}')" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}"

  add-comment:
    runs-on: ubuntu-latest
    needs: update-issue
    permissions:
      issues: write
    steps:
      - name: Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          jq -n \
            --arg body "ü§ñ **Feature request enhanced!**\n\nIssue description and requirements are now structured and documented." \
            '{body:$body}' \
          | curl -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              -d @- \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments"
