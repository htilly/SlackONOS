name: Enhance Feature Requests

on:
  issues:
    types: [opened, labeled]

jobs:
  check-label:
    runs-on: ubuntu-latest
    outputs:
      has_enhancement: ${{ steps.check.outputs.has_enhancement }}
      already_enhanced: ${{ steps.check-enhanced.outputs.already_enhanced }}
    steps:
      - name: Check if issue has enhancement label
        id: check
        run: |
          set -e  # Exit on error
          
          # Ensure jq is available
          if ! command -v jq &> /dev/null; then
            echo "‚ö†Ô∏è jq not found, installing..."
            sudo apt-get update && sudo apt-get install -y jq
          fi
          
          # Read enhanced task from JSON output to avoid shell quoting issues
          TASK_JSON="${{ needs.preprocess.outputs.task_json }}"
          if [ -n "$TASK_JSON" ] && [ "$TASK_JSON" != "null" ]; then
            # Extract values from JSON using jq
          set -e  # Exit on error
          
          # Ensure jq is available
          if ! command -v jq &> /dev/null; then
            echo "‚ö†Ô∏è jq not found, installing..."
            sudo apt-get update && sudo apt-get install -y jq
          fi
          

          set -e  # Exit on error
          
          # Ensure jq is available (should be pre-installed in ubuntu-latest)
          if ! command -v jq &> /dev/null; then
            echo "‚ö†Ô∏è jq not found, installing..."
            sudo apt-get update && sudo apt-get install -y jq
          fi
          

            ENHANCED_TASK=$(echo "$TASK_JSON" | jq -r '.enhanced // empty')
            ORIGINAL_TASK=$(echo "$TASK_JSON" | jq -r '.original // empty')
          else
            # Fallback to outputs if JSON not available
            ENHANCED_TASK="${{ needs.preprocess.outputs.enhanced_task }}"
            ORIGINAL_TASK="${{ github.event.issue.title }}"

          # Get original body (may be null/empty)
          ORIGINAL_BODY="${{ github.event.issue.body }}"
          if [ -z "$ORIGINAL_BODY" ] || [ "$ORIGINAL_BODY" = "null" ]; then
            ORIGINAL_BODY="_(No description provided)_"
          # Build enhanced body with proper escaping using jq
          ENHANCED_BODY=$(jq -n \
            --arg enhanced "$ENHANCED_TASK" \
            --arg original "$ORIGINAL_BODY" \
            --arg requester "${{ github.event.issue.user.login }}" \
            --arg created "${{ github.event.issue.created_at }}" \
            '"## üìù Enhanced Feature Request\n\n" + $enhanced + "\n\n---\n\n## üìã Original Request\n\n" + $original + "\n\n---\n\n**Requested by:** " + $requester + "  \n**Created:** " + $created')

          # Use jq to properly construct JSON payload for PATCH
          PAYLOAD=$(jq -n \
            --arg body "$ENHANCED_BODY" \
            '{body: $body}')

          # Update the issue
          curl -X PATCH "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"

          echo "‚úÖ Issue #${{ github.event.issue.number }} updated with enhanced description"

  add-comment:
    runs-on: ubuntu-latest
    needs: update-github-issue
    permissions:
      issues: write
    steps:
      - name: Add comment to issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Build comment with proper escaping using jq
          COMMENT=$(jq -n '"ü§ñ **Feature request enhanced!**\n\nThis feature request has been automatically enhanced with a structured user story format.\n\nThe issue description has been updated with acceptance criteria and technical notes."')

          # Use jq to properly construct JSON payload
          PAYLOAD=$(jq -n \
            --arg body "$COMMENT" \
            '{body: $body}')

          curl -X POST "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"

          echo "‚úÖ Added comment to issue"
