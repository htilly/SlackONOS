name: Build and Push Multi-Platform Docker Image

on:
  push:
    branches:
      - master

jobs:
  build-amd64:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v4.1.7

    - name: Docker Setup QEMU for amd64
      uses: docker/setup-qemu-action@v3.2.0
      
    - name: Set up Docker Buildx for amd64
      uses: docker/setup-buildx-action@v3.6.1

    - name: Log in to Docker Hub for amd64
      run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: Build and push Docker image for amd64
      run: |
        docker buildx build --platform linux/amd64 --push \
          -t ${{ secrets.DOCKERHUB_USERNAME }}/slackonos:amd64-latest .

  build-arm64:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v4.1.7

    - name: Docker Setup QEMU for arm64
      uses: docker/setup-qemu-action@v3.2.0
      
    - name: Set up Docker Buildx for arm64
      uses: docker/setup-buildx-action@v3.6.1

    - name: Log in to Docker Hub for arm64
      run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: Build and push Docker image for arm64
      run: |
        docker buildx build --platform linux/arm64 --push \
          -t ${{ secrets.DOCKERHUB_USERNAME }}/slackonos:arm64-latest .

  build-armv7:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v4.1.7

    - name: Docker Setup QEMU for armv7
      uses: docker/setup-qemu-action@v3.2.0
      
    - name: Set up Docker Buildx for armv7
      uses: docker/setup-buildx-action@v3.6.1

    - name: Log in to Docker Hub for armv7
      run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: Build and push Docker image for armv7
      run: |
        docker buildx build --platform linux/arm/v7 --push \
          -t ${{ secrets.DOCKERHUB_USERNAME }}/slackonos:armv7-latest .

  verify-manifest:
    needs: [build-amd64, build-arm64, build-armv7]
    runs-on: ubuntu-latest

    steps:
    - name: Verify the multi-platform image
      run: |
        docker buildx imagetools inspect ${{ secrets.DOCKERHUB_USERNAME }}/slackonos:latest
