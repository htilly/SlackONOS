import fs from "fs";
import { execSync } from "child_process";
import process from "process";

/* =========================
   Config & validation
========================= */

const {
  AI_PROVIDER = "claude",
  CLAUDE_API_KEY,
  ANTHROPIC_API_KEY,
  CLAUDE_MODEL = "claude-sonnet-4-5",
  TASK,
  REQUESTER,
} = process.env;

const apiKey = CLAUDE_API_KEY || ANTHROPIC_API_KEY;

if (!TASK) {
  throw new Error("TASK env var is required");
}

if (AI_PROVIDER !== "claude") {
  throw new Error(`Only Claude supported right now, got: ${AI_PROVIDER}`);
}

if (!apiKey) {
  throw new Error("Missing CLAUDE_API_KEY / ANTHROPIC_API_KEY");
}

const allowedClaudeModels = [
  "claude-sonnet-4-5",
  "claude-3-5-sonnet-20240620",
  "claude-3-sonnet-20240229",
  "claude-3-opus-20240229",
  "claude-3-haiku-20240307",
];

if (!allowedClaudeModels.includes(CLAUDE_MODEL)) {
  throw new Error(
    `Invalid Claude model "${CLAUDE_MODEL}". Allowed:\n` +
      allowedClaudeModels.join("\n")
  );
}

console.log(
  `[AGENT] Using Claude (Anthropic) with model: ${CLAUDE_MODEL}`
);
console.log(`[AGENT] Starting AI code agent for task: ${TASK}`);
console.log(`[AGENT] Requested by: ${REQUESTER}`);

/* =========================
   Claude API call
========================= */

async function callClaude(prompt) {
  const res = await fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-api-key": apiKey,
      "anthropic-version": "2023-06-01",
    },
    body: JSON.stringify({
      model: CLAUDE_MODEL,
      max_tokens: 4096,
      temperature: 0,
      messages: [
        {
          role: "user",
          content: [
            {
              type: "text",
              text: prompt,
            },
          ],
        },
      ],
    }),
  });

  if (!res.ok) {
    const text = await res.text();
    throw new Error(
      `CLAUDE API Error: ${res.status} ${text}`
    );
  }

  const json = await res.json();
  return json.content
    .map((c) => c.text)
    .join("\n");
}

/* =========================
   Diff extraction
========================= */

function extractPureDiff(text) {
  const start = text.indexOf("diff --git");
  if (start === -1) {
    throw new Error("No git diff found in Claude output");
  }

  let diff = text.slice(start).trim();

  // Strip anything after diff that is not part of it
  const lines = diff.split("\n");
  const clean = [];

  for (const line of lines) {
    if (
      line.startsWith("diff --git") ||
      line.startsWith("index ") ||
      line.startsWith("--- ") ||
      line.startsWith("+++ ") ||
      line.startsWith("@@") ||
      line.startsWith("+") ||
      line.startsWith("-") ||
      line.startsWith(" ")
    ) {
      clean.push(line);
    } else {
      break;
    }
  }

  return clean.join("\n") + "\n";
}

/* =========================
   Main
========================= */

(async () => {
  console.log("[AGENT] Calling CLAUDE API...");

  const prompt = `
You are an autonomous coding agent.

TASK:
${TASK}

RULES:
- Return ONLY a valid unified git diff
- Start with "diff --git"
- No markdown
- No explanations
- No commentary
- One patch only
`;

  const output = await callClaude(prompt);

  const diff = extractPureDiff(output);

  console.log(
    `[AGENT] Generated diff with ${diff.split("\n").length} lines changed`
  );

  const patchPath = "/tmp/aicode.patch";
  fs.writeFileSync(patchPath, diff, "utf8");

  try {
    execSync(`git apply --whitespace=fix ${patchPath}`, {
      stdio: "inherit",
    });
  } catch (err) {
    console.error("[AGENT] Patch Application Failed");
    console.error("Diff preview:\n```");
    console.error(diff);
    console.error("```");
    throw err;
  }

  console.log("[AGENT] Patch applied successfully");
})();
